# RNS Montgomery mutliplication with AVX512 and GPU

Disclaimer: This is research code and has not been vetted for security.

## Installation requirements

The code is written as standalone c++ template-header files, without additional dependencies.
Python dependencies include numpy, sympy, and matplotlib.

## Benchmarks

### AVX 512-IFMA
Testing was done with g++ 11.5

1. `python cpu.py 2 MULTS MODBITS` will run AVX512 RNS Montgomery multiplication with MULTS iterations and a MODBITS modulus.  The compiler is set to `g++` and will need to be changed as necessary.
2. `python cpu.py 2 MULTS MODULUS` will use the provided modulus if it is at least 32 bits.

The python script performs the following tasks
1. Calculate the precomputed values necessary for RNS Montgomery Multiplication
2. Calculate the RNS form of two random inputs
3. Write the precomputed constants and RNS form to a file `inputMODBITS.txt`
4. Compile the code with the parameters set for the modulus as `avxINTRNS2MODBITS.exe`
5. This executable accepts the number of iterations `MULTS` and precompute file name `FILE` as command line arguments, and can be run without python.
6. The python script provides the command line arguments and runs the c++ executable.
7. The python script uses pipe to extract the output of the C++
8. The python script checks the correctness of the output by converting from RNS form
9. The python script records the time taken, which it will print in a dictionary at the end.  This dictionary can be fed as input to create_graph.py


### Flint benchmarks
Testing was done with Flint 3.2.1

1. Install [FLINT](https://flintlib.org/downloads.html)
2. The script `cpu.py` expects the installation to be in `/usr/local/` and sets flags accordingly.  If installed elsewhere, these flags will need to be changed
3. Flint benchmark can be run with `python cpu.py 3 MULTS MODBITS`

### Running on a range of parameters

`python cpu.py 1` will automatically run on the parameters used in the paper.

### Arkworks benchmarks
Testing was done with cargo/rust 1.86

To run Arkworks
1. ``cd cpu/baselines/modmul``
2. ``cargo bench``

Arkworks requires moduli to be available at compile time.  It will take at least 16GB of RAM to compile the provided moduli.  The script `gen_rust.py` generates the needed rust file `modcache.rs` from `modcache.py` if you want to use other moduli.

### Graph generation

1. `python create_graph.py` generates the graphs used in the paper.
2. It expects the AVX data in the file `data/avx_metal.txt` and the rust data generated by criterion in the target directory.
3. The rust data for the paper has been saved in a tar file in `data/rust/data.tar`,
4. It will save .png files for each graph.

## GPU

## Installation requirements

Python dependencies: nvidia-cuda-toolkit
E.g using conda
`conda install -c conda-forge cuda-python`
`conda install -c "nvidia/label/cuda-12.2.1" cuda-toolkit`

Ensure CGBN is downloaded:
`git submodule update --init --recursive`

Ensure you have GPU drivers, nvcc installed
`nvidia-smi`
`nvcc --verison`

## Benchmarking

To run latency foccussed GPU benchmarks:
`python latency.py`

The python script performs the following tasks
1. Calculate various GPU configurations and their required parameters for CGBN and RNS Montgomery multiplication
2. The file `bench_cgbn.py` contains CGBN specific functions and `gpu.py` contains RNS Montgomery specific functions.  Each is devided into a `gen` func that creates data following the specific parameters, a `result` func that allocates data for results, and a `correct` func that checks the results.
3. The file `basic_benchmarker.py` calls the `gen` and `result` functions, and moves the corresponding data to the GPU.  It then runs the kernel and retrieves the results.  The results are passed to the `correct` function and data about performance is returned.

### Graph generation

Data can be found in the scripts/data/ folder

`python gpugraph.py` to generate graphs for the paper.